<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ASIAXpro</title>
  <!-- Tailwind not required, using included CSS below -->
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <!-- Ethers.js -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

  <style>
    :root {
      --bg: #071017;
      --card: #0d1b23;
      --muted: #b0c4d1;
      --accent: #00d1b2;
      --glass: rgba(255,255,255,0.06);
      --error: #ff6b6b;
      --success: #28a745;
    }
    html,body{height:100%;margin:0}
    body{
      background: radial-gradient(1200px 500px at 10% 10%, rgba(0,209,178,0.08), transparent),
                  linear-gradient(180deg,#071017 0%,#06111a 100%);
      color:#e6f7f4;
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing:antialiased;
      padding:16px;
    }
    .app{max-width:420px;margin:0 auto;padding-bottom:80px;}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:12px 8px;margin-bottom:16px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:48px;height:48px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#3ad7ff);display:grid;place-items:center;font-weight:700;color:#022;box-shadow:0 4px 12px rgba(0,0,0,0.5);border:none}
    h1.app-title{font-size:1.1rem;font-weight:600;margin:0}
    p.app-sub{font-size:0.85rem;color:var(--muted);margin:0}
    .card-app{background:linear-gradient(180deg,var(--glass),rgba(255,255,255,0.02));border:1px solid rgba(255,255,255,0.08);border-radius:16px;padding:20px;margin-bottom:16px;backdrop-filter:blur(8px);box-shadow:0 8px 24px rgba(2,8,12,0.5);animation:float 6s ease-in-out infinite}
    @keyframes float{0%{transform:translateY(0)}50%{transform:translateY(-8px)}100%{transform:translateY(0)}}
    .stats-row{display:flex;gap:12px;flex-wrap:wrap}
    .stat{flex:1;padding:14px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.03),transparent);display:flex;flex-direction:column;gap:8px;min-width:0}
    .stat .value{font-weight:600;font-size:1.1rem;display:flex;align-items:center;gap:6px}
    .stat small{color:var(--muted);font-size:0.9rem}
    .btn-lg-rounded{border-radius:12px;padding:12px 16px;font-weight:600;transition:background-color 0.2s,transform 0.1s}
    .btn-lg-rounded:hover{transform:translateY(-2px)}
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .form-control{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:inherit;height:48px;padding:12px;transition:border-color 0.2s}
    .form-control:focus{outline:none;border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,209,178,0.2)}
    .form-control::placeholder{color:var(--muted);opacity:0.7}
    .bottom-nav{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;width:calc(100% - 32px);max-width:420px;display:flex;gap:10px;background:var(--glass);padding:8px;border-radius:16px;backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.08);z-index:40}
    .nav-btn{flex:1;padding:12px;border-radius:10px;background:transparent;border:none;color:var(--muted);display:flex;align-items:center;justify-content:center;transition:background-color .2s,color .2s}
    .nav-btn.active{background:var(--accent);color:#022}
    .nav-btn:hover{background:rgba(255,255,255,0.1);color:var(--accent)}
    .status{font-size:0.9rem;padding:10px 12px;border-radius:10px;background:rgba(0,0,0,0.3);color:var(--muted);margin-bottom:12px;text-align:center}.status.error{color:var(--error);background:rgba(255,107,107,0.1)}.status.success{color:var(--success);background:rgba(40,167,69,0.1)}
    .small-muted{font-size:0.9rem;color:var(--muted)}.pulse{animation:pulse 2.5s infinite ease-in-out}

    @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(0,209,178,0.3)}70%{box-shadow:0 0 0 12px rgba(0,209,178,0)}100%{box-shadow:0 0 0 0 rgba(0,209,178,0)}}
    @media (min-width:560px){body{padding:24px}.card-app{padding:24px}.bottom-nav{bottom:24px}}
    @media (max-width:360px){.stats-row{flex-direction:column}.bottom-nav{flex-wrap:wrap}}
    /* Additional mobile fixes */
    @media (max-width: 320px) {
      .card-app { padding: 14px; }
      .btn-lg-rounded { padding: 8px; font-size: 0.85rem; min-height: 44px; }
      .form-control { height: 40px; font-size: 0.85rem; }
      .nav-btn { padding: 6px; font-size: 0.85rem; min-height: 44px; }
      .stats-row { gap: 6px; flex-direction: column; }
      .bottom-nav { gap: 4px; padding: 6px; }
    }
    @media (min-width: 360px) and (max-width: 414px) {
      .card-app { padding: 16px; }
      .btn-lg-rounded { padding: 10px; font-size: 0.95rem; }
      .form-control { font-size: 0.95rem; height: 44px; }
    }
    .app-title { font-size: clamp(1rem, 4vw, 1.2rem); }
    .small-muted { font-size: clamp(0.75rem, 3vw, 0.85rem); }
    .stat .value { font-size: clamp(0.95rem, 3.5vw, 1.05rem); }
    .btn, .btn-lg-rounded, .nav-btn {
      min-height: 44px;
      min-width: 44px;
      touch-action: manipulation;
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Topbar -->
    <div class="topbar">
      <div class="brand">
        <button class="logo" onclick="window.location.href='axmenu.html'" title="Open Menu">
          <i class="fa-solid fa-bars" style="color:#022"></i>
        </button>
        <div>
          <h1 class="app-title">ùêÄùêíùêàùêÄùêó ùêèùêëùêé</h1>
          <p class="app-sub">Empowering Wealth Creation</p>
        </div>
      </div>

      <button id="connectBtn" class="btn btn-sm btn-outline-light pulse" aria-label="Connect Wallet">
        <i class="fa-solid fa-wallet"></i>&nbsp;<span id="connectLabel">Connect</span>
      </button>
    </div>

    <!-- Status -->
    <div id="status" class="status">Not connected</div>

    <!-- Dashboard Card -->
    <div class="card-app">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="small-muted">Hello,</div>
          <div style="font-weight:600;font-size:1.1rem" id="userAddress">Not connected</div>
        </div>
        <div style="text-align:right">
          <button class="btn btn-sm btn-outline-info" id="backHomeBtn">
            <i class="fa-solid fa-arrow-left"></i> Home
          </button>
          <div id="totalUsers" style="font-weight:600;margin-top:6px;">MY TEAM</div>
        </div>
      </div>

      <div class="stats-row mt-4">
        <div class="stat">
          <div class="small-muted">Total Investment</div>
          <div class="value"><i class="fa-solid fa-coins"></i>&nbsp;<span id="totalInvestment">0</span> AX</div>
        </div>
        <div class="stat">
          <div class="small-muted">Wallet Balance</div>
          <div class="value"><i class="fa-solid fa-wallet"></i>&nbsp;<span id="walletBalance">0</span> AX</div>
        </div>
      </div>

      <div class="stats-row mt-3">
         <div class="stat">
          <div class="small-muted">Total Withdrawn</div>
          <div class="value"><i class="fa-solid fa-hand-holding-dollar"></i>&nbsp;<span id="totalWithdrawn">0</span> AX</div>
        </div>
        <div class="stat">
          <div class="small-muted">Pending ROI</div>
          <div class="value"><i class="fa-solid fa-chart-line"></i>&nbsp;<span id="pendingROI">0</span> AX</div>
        </div>
      </div>

      <div style="margin-top:16px"><div class="small-muted">Referral Income</div>
        <div style="display:flex;gap:12px;margin-top:8px">
          <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.03)"><small class="small-muted">Sponsor</small>
            <div id="sponsorIncome" style="font-weight:600">0</div>
          </div>
          <div style="flex:1;padding:12px;border-radius:10px;background:rgba(255,255,255,0.03)">
            <small class="small-muted">Generation</small>
            <div id="generationIncome" style="font-weight:600">0</div>
          </div>
        </div>

        <div style="display:flex;gap:12px;margin-top:12px">
          <div style="flex:1">
            <button id="claimReferralsBtn" class="btn btn-sm btn-outline-light w-100">
              Claim Referrals
            </button>
          </div>
          <div style="flex:1">
            <button id="refreshSmallBtn" class="btn btn-sm btn-outline-light w-100">
              <i class="fa-solid fa-rotate"></i> Refresh
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Invest Card -->
    <div class="card-app">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="small-muted">Invest</div>
          <div style="font-weight:600">Join & Add Funds</div>
        </div>
        <div style="font-size:1.3rem;color:var(--accent)"><i class="fa-solid fa-hand-holding-dollar"></i></div>
      </div>

      <div class="mt-4">
        <input id="referrer" class="form-control" placeholder="Referrer address (optional)" aria-label="Referrer Address" />
        <div class="input-group mt-3">
          <input id="amount" type="number" class="form-control" placeholder="Amount in ASIAX" aria-label="Investment Amount" />
          <button id="maxBtn" class="btn btn-outline-light" style="border-radius:0 10px 10px 0;">Max</button>
        </div>
        <div class="d-grid mt-4">
          <button id="investBtn" class="btn btn-lg btn-success btn-lg-rounded"><i class="fa-solid fa-paper-plane"></i> Invest</button>
        </div>
      </div>
    </div>

    <!-- Actions Card -->
    <div class="card-app">
      <div class="d-flex gap-3">
        <button id="withdrawBtn" class="btn btn-outline-light flex-fill" aria-label="Withdraw Funds">
          <i class="fa-solid fa-arrow-up-right-from-square"></i><br><small class="small-muted">Withdraw</small>
        </button>
        <button id="claimBtn" class="btn btn-outline-light flex-fill" aria-label="Claim Pool Rewards">
          <i class="fa-solid fa-gift"></i><br><small class="small-muted">Claim Pools</small>
        </button>
        <button id="refreshBtn" class="btn btn-outline-light flex-fill" aria-label="Refresh Data">
          <i class="fa-solid fa-rotate"></i><br><small class="small-muted">Refresh</small>
        </button>
      </div>
    </div>

    <!-- Wallet Withdraw Card -->
    <div class="card-app">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <div>
          <div class="small-muted">Wallet Withdraw</div>
          <div style="font-weight:600">Fast Withdraw</div>
        </div>
        <div style="font-size:1.3rem;color:#ffb86b"><i class="fa-solid fa-hand-holding-dollar"></i></div>
      </div>
      <div class="mt-4 d-flex gap-3">
        <input id="withdrawAmount" class="form-control" placeholder="Amount in ASIAX" aria-label="Withdraw Amount" />
        <button id="walletWithdrawBtn" class="btn btn-warning">Go</button>
      </div>
    </div>

    <!-- Note Card -->
    <div class="card-app small-muted" style="font-size:0.9rem">
      <div><strong>Note:</strong> Contract source provided. Ensure MetaMask is connected to Polygon Mainnet. This frontend uses token & contract addresses set in the script below.</div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
      <button class="nav-btn active" id="navHome" aria-label="Home"><i class="fa-solid fa-house"></i></button><button class="nav-btn" id="navInvest" aria-label="Invest"><i class="fa-solid fa-coins"></i></button>
      <button class="nav-btn" id="navStats" aria-label="Stats"><i class="fa-solid fa-chart-simple"></i></button>
      <button class="nav-btn" id="navMore" aria-label="More"><i class="fa-solid fa-ellipsis"></i></button>
    </div>
  </div>

  <script>
    // ----------------- CONFIG -----------------
    const CONTRACT_ADDRESS = "0xF6d0d72AAf0Bbf5C459E680f1e6E75E3B1ce1f06";
    const TOKEN_ADDRESS = "0xe36b5223d488322fac2ddda937e5ab226e83fbbd";

    const ABI = [
      "function invest(address _referrer, uint256 _amount) external",
      "function withdraw() external",
      "function claimPoolRewards() external",
      "function WalletWithdraw(uint256 _amount) external",
      "function userBasic(address) view returns (address,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256,uint256)",
      "function userWallet(address) view returns (uint256,uint256,uint256)",
      "function totalUsers() view returns (uint256)",
      "function getUserIncome(address) view returns (uint256,uint256,uint256,uint256,uint256)",
      "function getUserNetwork(address) view returns (uint256,uint256,bool,bool,bool)"
    ];
    const TOKEN_ABI = [
      "function balanceOf(address) view returns (uint256)",
      "function approve(address spender, uint256 amount) public returns (bool)",
      "function allowance(address owner, address spender) public view returns (uint256)",
      "function decimals() view returns (uint8)"
    ];

    // --------------- State -----------------
    let provider = null;
    let signer = null;
    let contract = null;
    let tokenContract = null;
    let autoRefreshHandle = null;
    const AUTO_REFRESH_INTERVAL = 20000;
    let DECIMALS = 18; // Fallback

    // --------------- Helpers -----------------
    async function getTokenDecimals() {
      try {
        return Number(await tokenContract.decimals());
      } catch (err) {
        console.error("Failed to fetch decimals:", err);
        return 18;
      }
    }

    function short(addr) {
      if (!addr) return '‚Äî';
      return addr.slice(0, 6) + "..." + addr.slice(-4);
    }

    function setStatus(text, isError = false) {
      const el = document.getElementById('status');
      el.innerText = text;
      el.className = 'status' + (isError ? ' error' : '');
    }

    async function toDisplay(amountBN) {
      try {
        return ethers.utils.formatUnits(amountBN, DECIMALS);
      } catch (e) {
        return "0";
      }
    }

    // --------------- Wallet / Connect -----------------
    async function connectWallet() {
      try {
        if (!window.ethereum) {
          alert("MetaMask / compatible wallet not found. Install wallet and try again.");
          return;
        }
        await window.ethereum.request({ method: "eth_requestAccounts" });
        provider = new ethers.providers.Web3Provider(window.ethereum);
        signer = provider.getSigner();
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if (code === "0x") {
          setStatus("Error: Contract not deployed at " + CONTRACT_ADDRESS, true);
          return;
        }
        contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);
        tokenContract = new ethers.Contract(TOKEN_ADDRESS, TOKEN_ABI, signer);
        DECIMALS = await getTokenDecimals();

        const network = await provider.getNetwork();
        if (network.chainId !== 137) {
          setStatus("Please switch MetaMask to Polygon Mainnet (137).", true);
        } else {
          setStatus("Connected to Polygon Mainnet", false);
        }
        const address = await signer.getAddress();
        document.getElementById('userAddress').innerText = short(address);
        document.getElementById('connectLabel').innerText = 'Connected';
        document.getElementById('connectBtn').classList.remove('pulse');

        await loadUserData();if (autoRefreshHandle) clearInterval(autoRefreshHandle);
        autoRefreshHandle = setInterval(() => {
          if (signer) loadUserData();
        }, AUTO_REFRESH_INTERVAL);

        window.ethereum.on('accountsChanged', (accounts) => {
          if (accounts.length === 0) {
            disconnect();
          } else {
            connectWallet();
          }
        });
        window.ethereum.on('chainChanged', () => {
          setTimeout(() => location.reload(), 300);
        });
      } catch (err) {
        console.error(err);
        setStatus("Connection failed: " + (err?.reason || err.message || String(err)), true);
      }
    }

    function disconnect() {
      provider = null;
      signer = null;
      contract = null;
      tokenContract = null;
      document.getElementById('userAddress').innerText = "Not connected";
      document.getElementById('connectLabel').innerText = "Connect";
      setStatus("Not connected", true);
      if (autoRefreshHandle) clearInterval(autoRefreshHandle);
    }

    // --------------- Read Data -----------------
    async function loadUserData() {
      try {
        if (!signer) return;
        const address = await signer.getAddress();
        const code = await provider.getCode(CONTRACT_ADDRESS);
        if (code === "0x") {
          setStatus("Contract not deployed at " + CONTRACT_ADDRESS, true);
          return;
        }
        const [basicRaw, walletRaw, networkRaw, incomeRaw] = await Promise.all([
          contract.userBasic(address),
          contract.userWallet(address),
          contract.getUserNetwork(address),
          contract.getUserIncome(address)
        ]);
        const totalInvestment = basicRaw[1];
        const totalWithdrawn = basicRaw[4];
        const sponsorIncome = basicRaw[5];
        const generationIncome = basicRaw[6];
        const walletBalance = walletRaw[0];
        const pendingROI = incomeRaw[0];
        const totalDownline = networkRaw[1];
        document.getElementById('totalInvestment').innerText = await toDisplay(totalInvestment);
        document.getElementById('walletBalance').innerText = await toDisplay(walletBalance);
        document.getElementById('totalWithdrawn').innerText = await toDisplay(totalWithdrawn);
        document.getElementById('sponsorIncome').innerText = await toDisplay(sponsorIncome);
        document.getElementById('generationIncome').innerText = await toDisplay(generationIncome);
        document.getElementById('pendingROI').innerText = await toDisplay(pendingROI);
        document.getElementById('totalUsers').innerText = totalDownline.toString();
        setStatus("Ready ‚Äî Polygon Mainnet", false);
      } catch (err) {
        console.error("loadUserData error:", err);
        setStatus("Failed to load user data: " + (err?.reason || err.message || String(err)), true);
      }
    }

    // --------------- Approve helper -----------------
    async function approveIfNeeded(amountBN) {
      try {
        const user = await signer.getAddress();
        const allowance = await tokenContract.allowance(user, CONTRACT_ADDRESS);
        if (allowance.gte(amountBN)) return null;
        const tx = await tokenContract.approve(CONTRACT_ADDRESS, amountBN, { gasLimit: 100000 });
        setStatus("Approving token... tx: " + tx.hash, false);
        await tx.wait();
        setStatus("Approval confirmed", false);
        return tx;
      } catch (err) {
        console.error("approveIfNeeded:", err);
        throw err;
      }
    }

    // --------------- Actions -----------------
    async function invest() {
      if (!contract) { 
        alert('Connect wallet first'); 
        return; 
      }
      const rawAmount = document.getElementById('amount').value;
      if (!rawAmount || Number(rawAmount) <= 0) {alert('Enter valid amount');
        return;
      }
      const amountBN = ethers.utils.parseUnits(String(rawAmount), DECIMALS);
      const user = await signer.getAddress();
      const isFirstTime = (await contract.userBasic(user))[2].eq(0);
      if (isFirstTime && Number(rawAmount) < 120) {
        alert('Minimum 120 AX for first investment');
        return;
      } else if (!isFirstTime && Number(rawAmount) < 10) {
        alert('Minimum 10 AX for subsequent investments');
        return;
      }
      if (Number(rawAmount) % 10 !== 0) {
        alert('Amount must be a multiple of 10');
        return;
      }

      // Balance check
      const balance = await tokenContract.balanceOf(user);
      if (balance.lt(amountBN)) {
        alert('Insufficient AX balance');
        return;
      }

      // Deposit limit check
      const userData = await contract.userBasic(user);
      if (userData[10].length >= 100) {
        alert('Maximum 100 deposits reached');
        return;
      }

      // Referrer validation
      const refInput = document.getElementById('referrer').value.trim();
      const ref = refInput && ethers.utils.isAddress(refInput) ? refInput : ethers.constants.AddressZero;
      if (ref !== ethers.constants.AddressZero) {
        const refData = await contract.userBasic(ref);
        if (refData[2].eq(0)) {
          alert('Referrer is not a registered user');
          return;
        }
      }

      try {
        document.getElementById('investBtn').disabled = true;
        document.getElementById('amount').disabled = true;
        document.getElementById('referrer').disabled = true;

        // Approve if needed
        await approveIfNeeded(amountBN);

        setStatus("Sending invest tx...", false);
        // Dynamic gas limit: 600k for first-time, 400k for others
        const gasLimit = isFirstTime ? 600000 : 400000;
        const tx = await contract.invest(ref, amountBN, { gasLimit: gasLimit });
        setStatus("Invest tx sent: " + tx.hash + " (check Polygonscan)", false);
        await tx.wait();
        setStatus("Invest successful! Reloading data...", false);
        await loadUserData();
      } catch (err) {
        console.error("Invest failed:", err);
        let errorMsg = "Invest failed";
        if (err.reason) {
          errorMsg += `: ${err.reason}`;
          if (err.reason.includes("Minimum 120AX")) {
            errorMsg = "Invest failed: Minimum 120 AX required for first investment";
          } else if (err.reason.includes("Max Deposit")) {
            errorMsg = "Invest failed: Maximum 100 deposits reached";
          } else if (err.reason.includes("Transfer failed")) {
            errorMsg = "Invest failed: Check token balance and allowance";
          }
        } else if (err.message && err.message.includes('out of gas')) {
          errorMsg += ": Increase gas limit in MetaMask (try 800,000)";
        } else if (err.message) {
          errorMsg += `: ${err.message}`;
        }
        setStatus(errorMsg, true);
      } finally {
        document.getElementById('investBtn').disabled = false;
        document.getElementById('amount').disabled = false;
        document.getElementById('referrer').disabled = false;
      }
    }

    async function withdraw() {
      if (!contract) { alert('Connect wallet first'); return; }
      try {
        document.getElementById('withdrawBtn').disabled = true;
        setStatus("Calling withdraw (claim incomes to wallet)...", false);
        const tx = await contract.withdraw({ gasLimit: 300000 });
        setStatus("Withdraw tx sent: " + tx.hash, false);
        await tx.wait();
        setStatus("Withdraw processed (check Wallet Balance)", false);
        await loadUserData();
      } catch (err) {
        console.error("withdraw:", err);
        setStatus("Withdraw failed: " + (err?.reason || err.message || String(err)), true);
      } finally {
        document.getElementById('withdrawBtn').disabled = false;
      }
    }async function claimPools() {
      if (!contract) { alert('Connect wallet first'); return; }
      try {
        document.getElementById('claimBtn').disabled = true;
        setStatus("Claiming pool rewards...", false);
        const tx = await contract.claimPoolRewards({ gasLimit: 300000 });
        setStatus("Claim tx sent: " + tx.hash, false);
        await tx.wait();
        setStatus("Pool claim success", false);
        await loadUserData();
      } catch (err) {
        console.error("claimPools:", err);
        setStatus("Claim failed: " + (err?.reason || err.message || String(err)), true);
      } finally {
        document.getElementById('claimBtn').disabled = false;
      }
    }

    async function claimReferrals() {
      if (!contract) { alert('Connect wallet first'); return; }
      try {
        document.getElementById('claimReferralsBtn').disabled = true;
        setStatus("Claiming referrals (this calls withdraw())...", false);
        const tx = await contract.withdraw({ gasLimit: 300000 });
        setStatus("Tx sent: " + tx.hash, false);
        await tx.wait();
        setStatus("Referrals moved to wallet balance. Now use Wallet Withdraw to get tokens.", false);
        await loadUserData();
      } catch (err) {
        console.error("claimReferrals:", err);
        setStatus("Claim referrals failed: " + (err?.reason || err.message || String(err)), true);
      } finally {
        document.getElementById('claimReferralsBtn').disabled = false;
      }
    }

    async function walletWithdraw() {
      if (!contract) { alert('Connect wallet first'); return; }
      const raw = document.getElementById('withdrawAmount').value;
      if (!raw || Number(raw) <= 0) { alert('Enter amount'); return; }
      if (Number(raw) < 10) { alert('Minimum withdrawal is 10 AX'); return; }
      if (Number(raw) > 1000) { alert('Maximum withdrawal is 1000 AX'); return; }
      const amount = ethers.utils.parseUnits(String(raw), DECIMALS);
      try {
        document.getElementById('walletWithdrawBtn').disabled = true;
        setStatus("Sending WalletWithdraw tx...", false);
        const tx = await contract.WalletWithdraw(amount, { gasLimit: 300000 });
        setStatus("WalletWithdraw tx sent: " + tx.hash, false);
        await tx.wait();
        setStatus("WalletWithdraw success ‚Äî tokens sent", false);
        await loadUserData();
      } catch (err) {
        console.error("walletWithdraw:", err);
        setStatus("Wallet withdraw failed: " + (err?.reason || err.message || String(err)), true);
      } finally {
        document.getElementById('walletWithdrawBtn').disabled = false;
      }
    }

    async function setMaxAmount() {
      try {
        if (!tokenContract || !signer) { alert('Connect wallet first'); return; }
        const user = await signer.getAddress();
        const bal = await tokenContract.balanceOf(user);
        document.getElementById('amount').value = await toDisplay(bal);
      } catch (err) {
        console.error("setMaxAmount:", err);
      }
    }

    // Event listeners
    document.getElementById('connectBtn').addEventListener('click', connectWallet);
    document.getElementById('investBtn').addEventListener('click', invest);
    document.getElementById('withdrawBtn').addEventListener('click', withdraw);
    document.getElementById('claimBtn').addEventListener('click', claimPools);
    document.getElementById('walletWithdrawBtn').addEventListener('click', walletWithdraw);
    document.getElementById('claimReferralsBtn').addEventListener('click', claimReferrals);
    document.getElementById('refreshBtn').addEventListener('click', () => { if (signer) loadUserData(); });
    document.getElementById('refreshSmallBtn').addEventListener('click', () => { if (signer) loadUserData(); });
    document.getElementById('maxBtn').addEventListener('click', (e) => { e.preventDefault(); setMaxAmount(); });
    document.getElementById('backHomeBtn').addEventListener('click', () => { window.location.href = 'index.html'; });// Referrer input validation
    document.getElementById('referrer').addEventListener('input', async () => {
      const refInput = document.getElementById('referrer');
      const value = refInput.value.trim();
      if (value && !ethers.utils.isAddress(value)) {
        refInput.classList.add('border-danger');
        setStatus('Invalid referrer address', true);
      } else if (value && ethers.utils.isAddress(value) && contract) {
        try {
          const refData = await contract.userBasic(value);
          if (refData[2].eq(0)) {
            refInput.classList.add('border-danger');
            setStatus('Referrer is not a registered user', true);
          } else {
            refInput.classList.remove('border-danger');
            setStatus('Ready', false);
          }
        } catch (err) {
          refInput.classList.add('border-danger');
          setStatus('Error validating referrer', true);
        }
      } else {
        refInput.classList.remove('border-danger');
        setStatus('Ready', false);
      }
    });

    // On load: indicate correct network if metamask present
    (async function init() {
      if (window.ethereum) {
        try {
          const tempProvider = new ethers.providers.Web3Provider(window.ethereum);
          const net = await tempProvider.getNetwork();
          if (net.chainId !== 137) {
            setStatus("Please switch MetaMask to Polygon Mainnet (137).", true);
          } else {
            setStatus("Ready ‚Äî Connect Wallet", false);
          }
        } catch(e) {
          // ignore
        }
      } else {
        setStatus("MetaMask not found. Install wallet.", true);
      }
    })();
  </script>
</body>
</html>
